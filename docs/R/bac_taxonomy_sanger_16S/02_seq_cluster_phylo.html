<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shane Hogle">
<meta name="dcterms.date" content="2025-07-31">

<title>Clustering/phylogenetics of 16S rRNA sequences from duckweed SynCom â€“ duckweedSynCom</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-1f23bf93a17969024013c136d185e5ce.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../R/bac_taxonomy_sanger_16S/01_read_format_sanger.html">1. Taxonomic characterization of plant-associated heterotrophic bacteria</a></li><li class="breadcrumb-item"><a href="../../R/bac_taxonomy_sanger_16S/02_seq_cluster_phylo.html">ii) Clustering and phylogeny of 16S gene</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">duckweedSynCom</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">1. Taxonomic characterization of plant-associated heterotrophic bacteria</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/bac_taxonomy_sanger_16S/01_read_format_sanger.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">i) 16S rRNA gene Sanger sequencing: Process ab1files to fasta</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/bac_taxonomy_sanger_16S/02_seq_cluster_phylo.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">ii) Clustering and phylogeny of 16S gene</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/bac_taxonomy_sanger_16S/03_tree_summary_table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">iii) Taxonomy summary</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">1</span> Setup</a></li>
  <li><a href="#read-and-format" id="toc-read-and-format" class="nav-link" data-scroll-target="#read-and-format"><span class="header-section-number">2</span> Read and format</a></li>
  <li><a href="#redundancy" id="toc-redundancy" class="nav-link" data-scroll-target="#redundancy"><span class="header-section-number">3</span> Redundancy</a></li>
  <li><a href="#cluster" id="toc-cluster" class="nav-link" data-scroll-target="#cluster"><span class="header-section-number">4</span> Cluster</a></li>
  <li><a href="#classify-idtaxa" id="toc-classify-idtaxa" class="nav-link" data-scroll-target="#classify-idtaxa"><span class="header-section-number">5</span> Classify (IDTAXA)</a></li>
  <li><a href="#classify-blastn" id="toc-classify-blastn" class="nav-link" data-scroll-target="#classify-blastn"><span class="header-section-number">6</span> Classify (Blastn)</a></li>
  <li><a href="#combine-clustering-and-classification" id="toc-combine-clustering-and-classification" class="nav-link" data-scroll-target="#combine-clustering-and-classification"><span class="header-section-number">7</span> Combine clustering and classification</a></li>
  <li><a href="#s-rrna-sequence-alignment" id="toc-s-rrna-sequence-alignment" class="nav-link" data-scroll-target="#s-rrna-sequence-alignment"><span class="header-section-number">8</span> 16S rRNA sequence alignment</a></li>
  <li><a href="#phylogenetic-tree-building" id="toc-phylogenetic-tree-building" class="nav-link" data-scroll-target="#phylogenetic-tree-building"><span class="header-section-number">9</span> Phylogenetic tree building</a></li>
  <li><a href="#aggregate-various-taxa-information" id="toc-aggregate-various-taxa-information" class="nav-link" data-scroll-target="#aggregate-various-taxa-information"><span class="header-section-number">10</span> Aggregate various taxa information</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../R/bac_taxonomy_sanger_16S/01_read_format_sanger.html">1. Taxonomic characterization of plant-associated heterotrophic bacteria</a></li><li class="breadcrumb-item"><a href="../../R/bac_taxonomy_sanger_16S/02_seq_cluster_phylo.html">ii) Clustering and phylogeny of 16S gene</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Clustering/phylogenetics of 16S rRNA sequences from duckweed SynCom</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shane Hogle </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 31, 2025</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    Various operations to group the isolates into clusters using clustering algorithms and phylogenetic inference. At the end a phylogenetic tree for the isolates is plotting with associated taxonomic information as well as clustering identity based on shared kmers.
  </div>
</div>


</header>


<section id="setup" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Setup</h1>
<p>Loads required libraries</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://packagemanager.posit.co/cran/__linux__/jammy/latest"</span>))</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(here)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(fs)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(DECIPHER)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="read-and-format" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Read and format</h1>
<p>Read 16S rRNA fasta sequences from the prior step.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>syncom16s_fna <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"16S_rRNA_SynCom.fna"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Convert to a DNA stringset object</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>syncom16s_seqs <span class="ot">&lt;-</span> <span class="fu">readDNAStringSet</span>(syncom16s_fna)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="redundancy" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Redundancy</h1>
<p>All sequences are unique which is expected</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">duplicated</span>(syncom16s_seqs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [49] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [61] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [73] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [85] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [97] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[109] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
</div>
</section>
<section id="cluster" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Cluster</h1>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">set.seed</span>(<span class="dv">36742</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>syncom16s_clusters <span class="ot">&lt;-</span> <span class="fu">Clusterize</span>(syncom16s_seqs,</span>
<span id="cb6-3"><a href="#cb6-3"></a>                       <span class="at">cutoff=</span><span class="fl">0.01</span>,     <span class="co"># at ~ species level (ie 99% identity)</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>                       <span class="at">minCoverage=</span><span class="fl">0.5</span>, <span class="co"># &gt; 50% coverage</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>                       <span class="at">processors=</span><span class="cn">NULL</span>) <span class="co"># use all CPUs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Partitioning sequences by 4-mer similarity:
================================================================================

Time difference of 0.05 secs

Sorting by relatedness within 32 groups:

iteration 1 of up to 43 (100.0% stability) 

Time difference of 0.04 secs

Clustering sequences by 10-mer similarity:
================================================================================

Time difference of 0.14 secs

Clusters via relatedness sorting: 100% (0% exclusively)
Clusters via rare 4-mers: 100% (0% exclusively)
Estimated clustering effectiveness: 100%</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># reset random seed</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="classify-idtaxa" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Classify (IDTAXA)</h1>
<p>Using <a href="https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-018-0521-5">IDTAXA</a> following the <a href="https://www2.decipher.codes/ClassifyOrganisms.html">approach shown here</a>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">set.seed</span>(<span class="dv">234676</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># load the training data set</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"idtaxa"</span>, <span class="st">"GTDB_r226-mod_April2025.RData"</span>))</span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co"># classify the sequences</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>syncom16s_ids <span class="ot">&lt;-</span> <span class="fu">IdTaxa</span>(syncom16s_seqs,</span>
<span id="cb9-8"><a href="#cb9-8"></a>   trainingSet,</span>
<span id="cb9-9"><a href="#cb9-9"></a>   <span class="at">strand=</span><span class="st">"both"</span>, <span class="co"># or "top" if same as trainingSet</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>   <span class="at">threshold=</span><span class="dv">60</span>, <span class="co"># 60 (cautious) or 50 (sensible)</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>   <span class="at">processors=</span><span class="cn">NULL</span>) <span class="co"># use all available processors</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co"># reset random seed</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>syncom16s_idtx <span class="ot">&lt;-</span> <span class="fu">imap</span>(</span>
<span id="cb10-2"><a href="#cb10-2"></a>  syncom16s_ids,</span>
<span id="cb10-3"><a href="#cb10-3"></a>  \(x, idx) <span class="fu">tibble</span>(<span class="at">a =</span> x<span class="sc">$</span>rank, <span class="at">b =</span> <span class="fu">paste</span>(x<span class="sc">$</span>taxon,<span class="st">" ("</span>,<span class="fu">round</span>(x<span class="sc">$</span>confidence, <span class="at">digits =</span> <span class="dv">1</span>),<span class="st">"%)"</span>, <span class="at">sep =</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> a, <span class="at">values_from =</span> b) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> idx)</span>
<span id="cb10-6"><a href="#cb10-6"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="fu">list_rbind</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="fu">relocate</span>(id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="classify-blastn" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Classify (Blastn)</h1>
<p>These steps need to be run outside of R/Rstudio</p>
<p>First we need to <a href="https://ftp.ncbi.nlm.nih.gov/blast/executables/LATEST/">download</a> and <a href="https://www.ncbi.nlm.nih.gov/books/NBK52640/">install</a> NCBI blast+ suite (I am using v2.16.0) and <a href="https://ftp.ncbi.nlm.nih.gov/blast/db/">download</a> the 16S_ribosomal_RNA database.</p>
<pre><code>blastn -num_threads 12 -db 16S_ribosomal_RNA -query 16S_rRNA_SynCom.fna -dust no -max_target_seqs 5 -out 16S_rRNA_SynCom_v_blast16SDB.tsv -outfmt "6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore staxid"</code></pre>
<p>The last column contains the taxonomy ID from the NCBI 16S Ribosomal database. We will just take the taxonomic lineage of the best hit</p>
<pre><code>csvtk tab2csv 16S_rRNA_SynCom_v_blast16SDB.tsv | csvtk cut -f1,13 | csvtk spread -k1 -v2 | sed 's/^,//g' | csvtk transpose | cut -d ";" -f1 | csvtk cut -f2,1 | csvtk csv2tab &gt; a
csvtk tab2csv 16S_rRNA_SynCom_v_blast16SDB.tsv | csvtk cut -f1,13 | csvtk spread -k1 -v2 | sed 's/^,//g' | csvtk transpose | cut -d ";" -f1 | csvtk cut -f2 | taxonkit lineage -n -L &gt; b
# combine into one file
paste a b &gt; blastn_lineage_best_hit.tsv
rm a b</code></pre>
<p>Now read this file back into R</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>syncom16s_blastn <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"blastn_lineage_best_hit.tsv"</span>),</span>
<span id="cb13-2"><a href="#cb13-2"></a>                <span class="at">col_names =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">id =</span> X2, <span class="at">ncbi_taxid =</span> X1, <span class="at">ncbi_best_species =</span> X4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="combine-clustering-and-classification" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Combine clustering and classification</h1>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>syncom16s_idtx_lineage_info <span class="ot">&lt;-</span> syncom16s_idtx <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">left_join</span>(<span class="fu">rownames_to_column</span>(syncom16s_clusters, <span class="at">var =</span> <span class="st">"id"</span>), <span class="at">by =</span> <span class="fu">join_by</span>(id)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">left_join</span>(syncom16s_blastn, <span class="at">by =</span> <span class="fu">join_by</span>(id)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">relocate</span>(ncbi_best_species, <span class="at">.after=</span><span class="st">"genus"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">relocate</span>(cluster, <span class="at">.after=</span><span class="st">"id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="fu">arrange</span>(cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="s-rrna-sequence-alignment" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> 16S rRNA sequence alignment</h1>
<p>We start with DNA sequences and convert to RNA so that DECIPHER can leverage structural information from the RNA</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>syncom16s_seqs_rna <span class="ot">&lt;-</span> <span class="fu">RNAStringSet</span>(syncom16s_seqs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Align the sequences</p>
<p>From <a href="https://bioconductor.org/packages/devel/bioc/vignettes/DECIPHER/inst/doc/ArtOfAlignmentInR.pdf">DECIPHER documentation on sequence alignment</a></p>
<blockquote class="blockquote">
<p>5.2 Example: Non-coding RNA sequences Much like proteins, non-coding RNAs often have a conserved secondary structure that can be used to improve their alignment. The PredictDBN function will predict base pairings from a sequence alignment by calculating the mutual information between pairs of positions. If RNA sequences are given as input, AlignSeqs will automatically use the output of PredictDBN to iteratively improve the alignment. Providing an RNAStringSet also causes single-base and double-base substitution matrices to be used, and is preferable to providing a DNAStringSet when the sequences are non-coding RNA. The type of the input sequences can easily be converted to RNA, as shown below.</p>
</blockquote>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">set.seed</span>(<span class="dv">2342</span>)</span>
<span id="cb16-2"><a href="#cb16-2"></a>syncom16s_seqs_rna_aligned <span class="ot">&lt;-</span> <span class="fu">AlignSeqs</span>(syncom16s_seqs_rna)</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co"># reset random seed</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># Write as aligned fasta DNA file </span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">writeXStringSet</span>(<span class="fu">DNAStringSet</span>(syncom16s_seqs_rna_aligned),</span>
<span id="cb17-3"><a href="#cb17-3"></a>                here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"16S_rRNA_SynCom_aligned.fna"</span>),</span>
<span id="cb17-4"><a href="#cb17-4"></a>                <span class="at">format=</span><span class="st">'fasta'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="phylogenetic-tree-building" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Phylogenetic tree building</h1>
<p>Following maximum likelihood tutorial <a href="https://bioconductor.org/packages/devel/bioc/vignettes/DECIPHER/inst/doc/GrowingTrees.pdf">DECIPHER documentation on phylogenetic trees</a></p>
<p>This step constructs a phylogenetic tree using the general time reversable (GTR) model with a discrete Gamma model <a href="https://link.springer.com/article/10.1007/BF00160154">(Yang, 1994)</a> with the default 4 rate categories. Branch support is depicted using aBayes probabilities, which is a Bayesian-like transformation of an approximate Likelihood Ratio Test <a href="https://academic.oup.com/sysbio/article/60/5/685/1644562">(Anisimova et al., 2011)</a>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">set.seed</span>(<span class="dv">26345</span>)</span>
<span id="cb18-2"><a href="#cb18-2"></a>syncom16s_seqs_mltree <span class="ot">&lt;-</span> <span class="fu">Treeline</span>(</span>
<span id="cb18-3"><a href="#cb18-3"></a>  syncom16s_seqs_rna_aligned,</span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="at">model =</span> <span class="st">"GTR+G4"</span>,</span>
<span id="cb18-6"><a href="#cb18-6"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="at">processors =</span> <span class="dv">12</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>)</span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co"># reset random seed</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># this function adds an 'edgetext' attribute that is recognized by WriteDendrogram so that</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># branch support values (aBayes) are written properly</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>add_boots <span class="ot">&lt;-</span> <span class="cf">function</span>(node){</span>
<span id="cb19-4"><a href="#cb19-4"></a>  s <span class="ot">&lt;-</span> <span class="fu">attr</span>(node, <span class="st">"probability"</span>)</span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(s))</span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="fu">attr</span>(node, <span class="st">"edgetext"</span>) <span class="ot">&lt;-</span> <span class="fu">formatC</span>(<span class="fu">as.numeric</span>(s), <span class="at">digits=</span><span class="dv">2</span>, <span class="at">format=</span><span class="st">"f"</span>)</span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="fu">return</span>(node)</span>
<span id="cb19-8"><a href="#cb19-8"></a>}</span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a>syncom16s_seqs_mltree <span class="ot">&lt;-</span> <span class="fu">dendrapply</span>(syncom16s_seqs_mltree, add_boots)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Save ML tree as newick file</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">WriteDendrogram</span>(syncom16s_seqs_mltree, </span>
<span id="cb20-2"><a href="#cb20-2"></a>                <span class="at">file=</span>here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_seqs_mltree.nwk"</span>),</span>
<span id="cb20-3"><a href="#cb20-3"></a>                <span class="co"># quote ="" ensure that bootstraps are not written quoted as strings</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>                <span class="co"># so that ggtree doesn't fail to parse them</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>                <span class="at">quote=</span><span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Tree building results</p>
<pre><code>Fitting initial tree to model:
GTR+G4 -ln(L) = 15520, AICc = 31633, BIC = 32781

Optimizing up to 400 candidate trees:
Tree #136. -ln(L) = 15395.993 (0.000%), 9 Climbs, 0 Grafts of 7                                                                                                       

Finalizing the best tree (#130):
-ln(L) = 15395.993 (0.000%), 1 Climb                                                                                                                                  

Model parameters:
Frequency(A) = 0.244
Frequency(C) = 0.223
Frequency(G) = 0.312
Frequency(T) = 0.221
Rate A &lt;-&gt; C = 0.816
Rate A &lt;-&gt; G = 1.978
Rate A &lt;-&gt; T = 1.262
Rate C &lt;-&gt; G = 0.677
Rate C &lt;-&gt; T = 3.029
Rate G &lt;-&gt; T = 1.000
Alpha = 0.302

Time difference of 1090.3 secs</code></pre>
</section>
<section id="aggregate-various-taxa-information" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Aggregate various taxa information</h1>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>sanger_batch_info <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"sanger_batch_info_01.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>final_table <span class="ot">&lt;-</span> <span class="fu">left_join</span>(syncom16s_idtx_lineage_info, sanger_batch_info, <span class="at">by =</span> <span class="fu">join_by</span>(id <span class="sc">==</span> strainID)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">strainID =</span> id, <span class="at">taxa_cluster =</span> cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">mutate</span>(<span class="at">genus1 =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(genus, <span class="st">"(^[:alpha:]*).*"</span>, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="fu">mutate</span>(<span class="at">genus1 =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(genus1) <span class="sc">|</span> genus1 <span class="sc">==</span> <span class="st">"unclassified"</span> <span class="sc">~</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(ncbi_best_species, <span class="st">"^[:alpha:]*"</span>),</span>
<span id="cb23-5"><a href="#cb23-5"></a>                           <span class="cn">TRUE</span> <span class="sc">~</span> genus1)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="fu">mutate</span>(<span class="at">tree_name =</span> <span class="fu">paste</span>(genus1, strainID)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="fu">relocate</span>(<span class="fu">c</span>(bacteria_plate_well, location, google_drive_id, tree_name), <span class="at">.after =</span> strainID) <span class="sc">%&gt;%</span> </span>
<span id="cb23-8"><a href="#cb23-8"></a>  <span class="fu">relocate</span>(google_drive_id, taxa_cluster, tree_name, <span class="at">.after =</span> strainID) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9"></a>  <span class="fu">relocate</span>(ncbi_best_species, ncbi_taxid, <span class="at">.after =</span> location) <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="#cb23-10"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>genus1)</span>
<span id="cb23-11"><a href="#cb23-11"></a></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="fu">write_tsv</span>(final_table, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"strain_table_info.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="an">title:</span><span class="co"> "Clustering/phylogenetics of 16S rRNA sequences from duckweed SynCom"</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="an">subtitle:</span><span class="co"> ""</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="an">author:</span><span class="co"> "Shane Hogle"</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="an">abstract:</span><span class="co"> "Various operations to group the isolates into clusters using clustering algorithms and phylogenetic inference. At the end a phylogenetic tree for the isolates is plotting with associated taxonomic information as well as clustering identity based on shared kmers."</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co">---</span></span>
<span id="cb24-8"><a href="#cb24-8"></a></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="fu"># Setup</span></span>
<span id="cb24-10"><a href="#cb24-10"></a></span>
<span id="cb24-11"><a href="#cb24-11"></a>Loads required libraries</span>
<span id="cb24-12"><a href="#cb24-12"></a></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="in">```{r}</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co">#| output: false</span></span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://packagemanager.posit.co/cran/__linux__/jammy/latest"</span>))</span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb24-19"><a href="#cb24-19"></a><span class="fu">library</span>(here)</span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="fu">library</span>(fs)</span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="fu">library</span>(DECIPHER)</span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="in">```</span></span>
<span id="cb24-23"><a href="#cb24-23"></a></span>
<span id="cb24-24"><a href="#cb24-24"></a><span class="fu"># Read and format</span></span>
<span id="cb24-25"><a href="#cb24-25"></a></span>
<span id="cb24-26"><a href="#cb24-26"></a>Read 16S rRNA fasta sequences from the prior step.</span>
<span id="cb24-27"><a href="#cb24-27"></a></span>
<span id="cb24-30"><a href="#cb24-30"></a><span class="in">```{r}</span></span>
<span id="cb24-31"><a href="#cb24-31"></a>syncom16s_fna <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"16S_rRNA_SynCom.fna"</span>)</span>
<span id="cb24-32"><a href="#cb24-32"></a><span class="in">```</span></span>
<span id="cb24-33"><a href="#cb24-33"></a></span>
<span id="cb24-34"><a href="#cb24-34"></a>Convert to a DNA stringset object</span>
<span id="cb24-35"><a href="#cb24-35"></a></span>
<span id="cb24-38"><a href="#cb24-38"></a><span class="in">```{r}</span></span>
<span id="cb24-39"><a href="#cb24-39"></a>syncom16s_seqs <span class="ot">&lt;-</span> <span class="fu">readDNAStringSet</span>(syncom16s_fna)</span>
<span id="cb24-40"><a href="#cb24-40"></a><span class="in">```</span></span>
<span id="cb24-41"><a href="#cb24-41"></a></span>
<span id="cb24-42"><a href="#cb24-42"></a><span class="fu"># Redundancy</span></span>
<span id="cb24-43"><a href="#cb24-43"></a></span>
<span id="cb24-44"><a href="#cb24-44"></a>All sequences are unique which is expected</span>
<span id="cb24-45"><a href="#cb24-45"></a></span>
<span id="cb24-48"><a href="#cb24-48"></a><span class="in">```{r}</span></span>
<span id="cb24-49"><a href="#cb24-49"></a><span class="fu">duplicated</span>(syncom16s_seqs)</span>
<span id="cb24-50"><a href="#cb24-50"></a><span class="in">```</span></span>
<span id="cb24-51"><a href="#cb24-51"></a></span>
<span id="cb24-52"><a href="#cb24-52"></a><span class="fu"># Cluster</span></span>
<span id="cb24-53"><a href="#cb24-53"></a></span>
<span id="cb24-56"><a href="#cb24-56"></a><span class="in">```{r}</span></span>
<span id="cb24-57"><a href="#cb24-57"></a><span class="fu">set.seed</span>(<span class="dv">36742</span>)</span>
<span id="cb24-58"><a href="#cb24-58"></a>syncom16s_clusters <span class="ot">&lt;-</span> <span class="fu">Clusterize</span>(syncom16s_seqs,</span>
<span id="cb24-59"><a href="#cb24-59"></a>                       <span class="at">cutoff=</span><span class="fl">0.01</span>,     <span class="co"># at ~ species level (ie 99% identity)</span></span>
<span id="cb24-60"><a href="#cb24-60"></a>                       <span class="at">minCoverage=</span><span class="fl">0.5</span>, <span class="co"># &gt; 50% coverage</span></span>
<span id="cb24-61"><a href="#cb24-61"></a>                       <span class="at">processors=</span><span class="cn">NULL</span>) <span class="co"># use all CPUs</span></span>
<span id="cb24-62"><a href="#cb24-62"></a><span class="co"># reset random seed</span></span>
<span id="cb24-63"><a href="#cb24-63"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span>
<span id="cb24-64"><a href="#cb24-64"></a><span class="in">```</span></span>
<span id="cb24-65"><a href="#cb24-65"></a></span>
<span id="cb24-66"><a href="#cb24-66"></a><span class="fu"># Classify (IDTAXA)</span></span>
<span id="cb24-67"><a href="#cb24-67"></a></span>
<span id="cb24-68"><a href="#cb24-68"></a>Using</span>
<span id="cb24-69"><a href="#cb24-69"></a><span class="co">[</span><span class="ot">IDTAXA</span><span class="co">](https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-018-0521-5)</span></span>
<span id="cb24-70"><a href="#cb24-70"></a>following the [approach shown</span>
<span id="cb24-71"><a href="#cb24-71"></a>here](https://www2.decipher.codes/ClassifyOrganisms.html).</span>
<span id="cb24-72"><a href="#cb24-72"></a></span>
<span id="cb24-75"><a href="#cb24-75"></a><span class="in">```{r}</span></span>
<span id="cb24-76"><a href="#cb24-76"></a><span class="co">#| eval: false</span></span>
<span id="cb24-77"><a href="#cb24-77"></a><span class="co">#| include: true</span></span>
<span id="cb24-78"><a href="#cb24-78"></a><span class="fu">set.seed</span>(<span class="dv">234676</span>)</span>
<span id="cb24-79"><a href="#cb24-79"></a></span>
<span id="cb24-80"><a href="#cb24-80"></a><span class="co"># load the training data set</span></span>
<span id="cb24-81"><a href="#cb24-81"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"idtaxa"</span>, <span class="st">"GTDB_r226-mod_April2025.RData"</span>))</span>
<span id="cb24-82"><a href="#cb24-82"></a></span>
<span id="cb24-83"><a href="#cb24-83"></a><span class="co"># classify the sequences</span></span>
<span id="cb24-84"><a href="#cb24-84"></a>syncom16s_ids <span class="ot">&lt;-</span> <span class="fu">IdTaxa</span>(syncom16s_seqs,</span>
<span id="cb24-85"><a href="#cb24-85"></a>   trainingSet,</span>
<span id="cb24-86"><a href="#cb24-86"></a>   <span class="at">strand=</span><span class="st">"both"</span>, <span class="co"># or "top" if same as trainingSet</span></span>
<span id="cb24-87"><a href="#cb24-87"></a>   <span class="at">threshold=</span><span class="dv">60</span>, <span class="co"># 60 (cautious) or 50 (sensible)</span></span>
<span id="cb24-88"><a href="#cb24-88"></a>   <span class="at">processors=</span><span class="cn">NULL</span>) <span class="co"># use all available processors</span></span>
<span id="cb24-89"><a href="#cb24-89"></a><span class="co"># reset random seed</span></span>
<span id="cb24-90"><a href="#cb24-90"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span>
<span id="cb24-91"><a href="#cb24-91"></a><span class="in">```</span></span>
<span id="cb24-92"><a href="#cb24-92"></a></span>
<span id="cb24-95"><a href="#cb24-95"></a><span class="in">```{r}</span></span>
<span id="cb24-96"><a href="#cb24-96"></a><span class="co">#| eval: false</span></span>
<span id="cb24-97"><a href="#cb24-97"></a><span class="co">#| include: false</span></span>
<span id="cb24-98"><a href="#cb24-98"></a><span class="fu">write_rds</span>(syncom16s_ids, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_ids.rds"</span>))</span>
<span id="cb24-99"><a href="#cb24-99"></a><span class="in">```</span></span>
<span id="cb24-100"><a href="#cb24-100"></a></span>
<span id="cb24-103"><a href="#cb24-103"></a><span class="in">```{r}</span></span>
<span id="cb24-104"><a href="#cb24-104"></a><span class="co">#| eval: true</span></span>
<span id="cb24-105"><a href="#cb24-105"></a><span class="co">#| include: false</span></span>
<span id="cb24-106"><a href="#cb24-106"></a>syncom16s_ids <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_ids.rds"</span>))</span>
<span id="cb24-107"><a href="#cb24-107"></a><span class="in">```</span></span>
<span id="cb24-108"><a href="#cb24-108"></a></span>
<span id="cb24-111"><a href="#cb24-111"></a><span class="in">```{r}</span></span>
<span id="cb24-112"><a href="#cb24-112"></a>syncom16s_idtx <span class="ot">&lt;-</span> <span class="fu">imap</span>(</span>
<span id="cb24-113"><a href="#cb24-113"></a>  syncom16s_ids,</span>
<span id="cb24-114"><a href="#cb24-114"></a>  \(x, idx) <span class="fu">tibble</span>(<span class="at">a =</span> x<span class="sc">$</span>rank, <span class="at">b =</span> <span class="fu">paste</span>(x<span class="sc">$</span>taxon,<span class="st">" ("</span>,<span class="fu">round</span>(x<span class="sc">$</span>confidence, <span class="at">digits =</span> <span class="dv">1</span>),<span class="st">"%)"</span>, <span class="at">sep =</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-115"><a href="#cb24-115"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> a, <span class="at">values_from =</span> b) <span class="sc">%&gt;%</span></span>
<span id="cb24-116"><a href="#cb24-116"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> idx)</span>
<span id="cb24-117"><a href="#cb24-117"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb24-118"><a href="#cb24-118"></a>  <span class="fu">list_rbind</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-119"><a href="#cb24-119"></a>  <span class="fu">relocate</span>(id)</span>
<span id="cb24-120"><a href="#cb24-120"></a><span class="in">```</span></span>
<span id="cb24-121"><a href="#cb24-121"></a></span>
<span id="cb24-122"><a href="#cb24-122"></a><span class="fu"># Classify (Blastn)</span></span>
<span id="cb24-123"><a href="#cb24-123"></a></span>
<span id="cb24-124"><a href="#cb24-124"></a>These steps need to be run outside of R/Rstudio</span>
<span id="cb24-125"><a href="#cb24-125"></a></span>
<span id="cb24-126"><a href="#cb24-126"></a>First we need to</span>
<span id="cb24-127"><a href="#cb24-127"></a><span class="co">[</span><span class="ot">download</span><span class="co">](https://ftp.ncbi.nlm.nih.gov/blast/executables/LATEST/)</span> and</span>
<span id="cb24-128"><a href="#cb24-128"></a><span class="co">[</span><span class="ot">install</span><span class="co">](https://www.ncbi.nlm.nih.gov/books/NBK52640/)</span> NCBI blast+</span>
<span id="cb24-129"><a href="#cb24-129"></a>suite (I am using v2.16.0) and</span>
<span id="cb24-130"><a href="#cb24-130"></a><span class="co">[</span><span class="ot">download</span><span class="co">](https://ftp.ncbi.nlm.nih.gov/blast/db/)</span> the 16S_ribosomal_RNA</span>
<span id="cb24-131"><a href="#cb24-131"></a>database.</span>
<span id="cb24-132"><a href="#cb24-132"></a></span>
<span id="cb24-133"><a href="#cb24-133"></a><span class="in">```</span></span>
<span id="cb24-134"><a href="#cb24-134"></a><span class="in">blastn -num_threads 12 -db 16S_ribosomal_RNA -query 16S_rRNA_SynCom.fna -dust no -max_target_seqs 5 -out 16S_rRNA_SynCom_v_blast16SDB.tsv -outfmt "6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore staxid"</span></span>
<span id="cb24-135"><a href="#cb24-135"></a><span class="in">```</span></span>
<span id="cb24-136"><a href="#cb24-136"></a></span>
<span id="cb24-137"><a href="#cb24-137"></a>The last column contains the taxonomy ID from the NCBI 16S Ribosomal</span>
<span id="cb24-138"><a href="#cb24-138"></a>database. We will just take the taxonomic lineage of the best hit</span>
<span id="cb24-139"><a href="#cb24-139"></a></span>
<span id="cb24-140"><a href="#cb24-140"></a><span class="in">```</span></span>
<span id="cb24-141"><a href="#cb24-141"></a><span class="in">csvtk tab2csv 16S_rRNA_SynCom_v_blast16SDB.tsv | csvtk cut -f1,13 | csvtk spread -k1 -v2 | sed 's/^,//g' | csvtk transpose | cut -d ";" -f1 | csvtk cut -f2,1 | csvtk csv2tab &gt; a</span></span>
<span id="cb24-142"><a href="#cb24-142"></a><span class="in">csvtk tab2csv 16S_rRNA_SynCom_v_blast16SDB.tsv | csvtk cut -f1,13 | csvtk spread -k1 -v2 | sed 's/^,//g' | csvtk transpose | cut -d ";" -f1 | csvtk cut -f2 | taxonkit lineage -n -L &gt; b</span></span>
<span id="cb24-143"><a href="#cb24-143"></a><span class="in"># combine into one file</span></span>
<span id="cb24-144"><a href="#cb24-144"></a><span class="in">paste a b &gt; blastn_lineage_best_hit.tsv</span></span>
<span id="cb24-145"><a href="#cb24-145"></a><span class="in">rm a b</span></span>
<span id="cb24-146"><a href="#cb24-146"></a><span class="in">```</span></span>
<span id="cb24-147"><a href="#cb24-147"></a></span>
<span id="cb24-148"><a href="#cb24-148"></a>Now read this file back into R</span>
<span id="cb24-149"><a href="#cb24-149"></a></span>
<span id="cb24-152"><a href="#cb24-152"></a><span class="in">```{r}</span></span>
<span id="cb24-153"><a href="#cb24-153"></a><span class="co">#| echo: true</span></span>
<span id="cb24-154"><a href="#cb24-154"></a><span class="co">#| output: false</span></span>
<span id="cb24-155"><a href="#cb24-155"></a>syncom16s_blastn <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"blastn_lineage_best_hit.tsv"</span>),</span>
<span id="cb24-156"><a href="#cb24-156"></a>                <span class="at">col_names =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-157"><a href="#cb24-157"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">id =</span> X2, <span class="at">ncbi_taxid =</span> X1, <span class="at">ncbi_best_species =</span> X4)</span>
<span id="cb24-158"><a href="#cb24-158"></a><span class="in">```</span></span>
<span id="cb24-159"><a href="#cb24-159"></a></span>
<span id="cb24-160"><a href="#cb24-160"></a><span class="fu"># Combine clustering and classification</span></span>
<span id="cb24-161"><a href="#cb24-161"></a></span>
<span id="cb24-164"><a href="#cb24-164"></a><span class="in">```{r}</span></span>
<span id="cb24-165"><a href="#cb24-165"></a>syncom16s_idtx_lineage_info <span class="ot">&lt;-</span> syncom16s_idtx <span class="sc">%&gt;%</span> </span>
<span id="cb24-166"><a href="#cb24-166"></a>  <span class="fu">left_join</span>(<span class="fu">rownames_to_column</span>(syncom16s_clusters, <span class="at">var =</span> <span class="st">"id"</span>), <span class="at">by =</span> <span class="fu">join_by</span>(id)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-167"><a href="#cb24-167"></a>  <span class="fu">left_join</span>(syncom16s_blastn, <span class="at">by =</span> <span class="fu">join_by</span>(id)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-168"><a href="#cb24-168"></a>  <span class="fu">relocate</span>(ncbi_best_species, <span class="at">.after=</span><span class="st">"genus"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-169"><a href="#cb24-169"></a>  <span class="fu">relocate</span>(cluster, <span class="at">.after=</span><span class="st">"id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-170"><a href="#cb24-170"></a>  <span class="fu">arrange</span>(cluster)</span>
<span id="cb24-171"><a href="#cb24-171"></a><span class="in">```</span></span>
<span id="cb24-172"><a href="#cb24-172"></a></span>
<span id="cb24-173"><a href="#cb24-173"></a><span class="fu"># 16S rRNA sequence alignment</span></span>
<span id="cb24-174"><a href="#cb24-174"></a></span>
<span id="cb24-175"><a href="#cb24-175"></a>We start with DNA sequences and convert to RNA so that DECIPHER can leverage structural information from the RNA</span>
<span id="cb24-176"><a href="#cb24-176"></a></span>
<span id="cb24-179"><a href="#cb24-179"></a><span class="in">```{r}</span></span>
<span id="cb24-180"><a href="#cb24-180"></a>syncom16s_seqs_rna <span class="ot">&lt;-</span> <span class="fu">RNAStringSet</span>(syncom16s_seqs)</span>
<span id="cb24-181"><a href="#cb24-181"></a><span class="in">```</span></span>
<span id="cb24-182"><a href="#cb24-182"></a></span>
<span id="cb24-183"><a href="#cb24-183"></a>Align the sequences</span>
<span id="cb24-184"><a href="#cb24-184"></a></span>
<span id="cb24-185"><a href="#cb24-185"></a>From [DECIPHER documentation on sequence</span>
<span id="cb24-186"><a href="#cb24-186"></a>alignment](https://bioconductor.org/packages/devel/bioc/vignettes/DECIPHER/inst/doc/ArtOfAlignmentInR.pdf)</span>
<span id="cb24-187"><a href="#cb24-187"></a></span>
<span id="cb24-188"><a href="#cb24-188"></a><span class="at">&gt; 5.2 Example: Non-coding RNA sequences Much like proteins, non-coding</span></span>
<span id="cb24-189"><a href="#cb24-189"></a><span class="at">&gt; RNAs often have a conserved secondary structure that can be used to</span></span>
<span id="cb24-190"><a href="#cb24-190"></a><span class="at">&gt; improve their alignment. The PredictDBN function will predict base</span></span>
<span id="cb24-191"><a href="#cb24-191"></a><span class="at">&gt; pairings from a sequence alignment by calculating the mutual</span></span>
<span id="cb24-192"><a href="#cb24-192"></a><span class="at">&gt; information between pairs of positions. If RNA sequences are given as</span></span>
<span id="cb24-193"><a href="#cb24-193"></a><span class="at">&gt; input, AlignSeqs will automatically use the output of PredictDBN to</span></span>
<span id="cb24-194"><a href="#cb24-194"></a><span class="at">&gt; iteratively improve the alignment. Providing an RNAStringSet also</span></span>
<span id="cb24-195"><a href="#cb24-195"></a><span class="at">&gt; causes single-base and double-base substitution matrices to be used,</span></span>
<span id="cb24-196"><a href="#cb24-196"></a><span class="at">&gt; and is preferable to providing a DNAStringSet when the sequences are</span></span>
<span id="cb24-197"><a href="#cb24-197"></a><span class="at">&gt; non-coding RNA. The type of the input sequences can easily be</span></span>
<span id="cb24-198"><a href="#cb24-198"></a><span class="at">&gt; converted to RNA, as shown below.</span></span>
<span id="cb24-199"><a href="#cb24-199"></a></span>
<span id="cb24-202"><a href="#cb24-202"></a><span class="in">```{r}</span></span>
<span id="cb24-203"><a href="#cb24-203"></a><span class="co">#| eval: false</span></span>
<span id="cb24-204"><a href="#cb24-204"></a><span class="co">#| include: true</span></span>
<span id="cb24-205"><a href="#cb24-205"></a><span class="fu">set.seed</span>(<span class="dv">2342</span>)</span>
<span id="cb24-206"><a href="#cb24-206"></a>syncom16s_seqs_rna_aligned <span class="ot">&lt;-</span> <span class="fu">AlignSeqs</span>(syncom16s_seqs_rna)</span>
<span id="cb24-207"><a href="#cb24-207"></a><span class="co"># reset random seed</span></span>
<span id="cb24-208"><a href="#cb24-208"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span>
<span id="cb24-209"><a href="#cb24-209"></a><span class="in">```</span></span>
<span id="cb24-210"><a href="#cb24-210"></a></span>
<span id="cb24-213"><a href="#cb24-213"></a><span class="in">```{r}</span></span>
<span id="cb24-214"><a href="#cb24-214"></a><span class="co">#| eval: false</span></span>
<span id="cb24-215"><a href="#cb24-215"></a><span class="co">#| include: false</span></span>
<span id="cb24-216"><a href="#cb24-216"></a><span class="fu">write_rds</span>(syncom16s_seqs_rna_aligned, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_seqs_rna_aligned.rds"</span>))</span>
<span id="cb24-217"><a href="#cb24-217"></a><span class="in">```</span></span>
<span id="cb24-218"><a href="#cb24-218"></a></span>
<span id="cb24-221"><a href="#cb24-221"></a><span class="in">```{r}</span></span>
<span id="cb24-222"><a href="#cb24-222"></a><span class="co">#| eval: true</span></span>
<span id="cb24-223"><a href="#cb24-223"></a><span class="co">#| include: false</span></span>
<span id="cb24-224"><a href="#cb24-224"></a>syncom16s_seqs_rna_aligned <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_seqs_rna_aligned.rds"</span>))</span>
<span id="cb24-225"><a href="#cb24-225"></a><span class="in">```</span></span>
<span id="cb24-226"><a href="#cb24-226"></a></span>
<span id="cb24-229"><a href="#cb24-229"></a><span class="in">```{r}</span></span>
<span id="cb24-230"><a href="#cb24-230"></a><span class="co"># Write as aligned fasta DNA file </span></span>
<span id="cb24-231"><a href="#cb24-231"></a><span class="fu">writeXStringSet</span>(<span class="fu">DNAStringSet</span>(syncom16s_seqs_rna_aligned),</span>
<span id="cb24-232"><a href="#cb24-232"></a>                here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"16S_rRNA_SynCom_aligned.fna"</span>),</span>
<span id="cb24-233"><a href="#cb24-233"></a>                <span class="at">format=</span><span class="st">'fasta'</span>)</span>
<span id="cb24-234"><a href="#cb24-234"></a><span class="in">```</span></span>
<span id="cb24-235"><a href="#cb24-235"></a></span>
<span id="cb24-236"><a href="#cb24-236"></a><span class="fu"># Phylogenetic tree building</span></span>
<span id="cb24-237"><a href="#cb24-237"></a></span>
<span id="cb24-238"><a href="#cb24-238"></a>Following maximum likelihood tutorial [DECIPHER documentation on</span>
<span id="cb24-239"><a href="#cb24-239"></a>phylogenetic</span>
<span id="cb24-240"><a href="#cb24-240"></a>trees](https://bioconductor.org/packages/devel/bioc/vignettes/DECIPHER/inst/doc/GrowingTrees.pdf)</span>
<span id="cb24-241"><a href="#cb24-241"></a></span>
<span id="cb24-242"><a href="#cb24-242"></a>This step constructs a phylogenetic tree using the general time reversable (GTR) model with a discrete Gamma model <span class="co">[</span><span class="ot">(Yang, 1994)</span><span class="co">](https://link.springer.com/article/10.1007/BF00160154)</span> with the default 4 rate categories. Branch support is depicted using aBayes probabilities, which is a Bayesian-like transformation of an approximate Likelihood Ratio Test <span class="co">[</span><span class="ot">(Anisimova et al., 2011)</span><span class="co">](https://academic.oup.com/sysbio/article/60/5/685/1644562)</span>. </span>
<span id="cb24-243"><a href="#cb24-243"></a></span>
<span id="cb24-246"><a href="#cb24-246"></a><span class="in">```{r}</span></span>
<span id="cb24-247"><a href="#cb24-247"></a><span class="co">#| eval: false</span></span>
<span id="cb24-248"><a href="#cb24-248"></a><span class="co">#| include: true</span></span>
<span id="cb24-249"><a href="#cb24-249"></a><span class="fu">set.seed</span>(<span class="dv">26345</span>)</span>
<span id="cb24-250"><a href="#cb24-250"></a>syncom16s_seqs_mltree <span class="ot">&lt;-</span> <span class="fu">Treeline</span>(</span>
<span id="cb24-251"><a href="#cb24-251"></a>  syncom16s_seqs_rna_aligned,</span>
<span id="cb24-252"><a href="#cb24-252"></a>  <span class="at">method =</span> <span class="st">"ML"</span>,</span>
<span id="cb24-253"><a href="#cb24-253"></a>  <span class="at">model =</span> <span class="st">"GTR+G4"</span>,</span>
<span id="cb24-254"><a href="#cb24-254"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-255"><a href="#cb24-255"></a>  <span class="at">processors =</span> <span class="dv">12</span></span>
<span id="cb24-256"><a href="#cb24-256"></a>)</span>
<span id="cb24-257"><a href="#cb24-257"></a><span class="co"># reset random seed</span></span>
<span id="cb24-258"><a href="#cb24-258"></a><span class="fu">rm</span>(.Random.seed, <span class="at">envir=</span><span class="fu">globalenv</span>())</span>
<span id="cb24-259"><a href="#cb24-259"></a><span class="in">```</span></span>
<span id="cb24-260"><a href="#cb24-260"></a></span>
<span id="cb24-263"><a href="#cb24-263"></a><span class="in">```{r}</span></span>
<span id="cb24-264"><a href="#cb24-264"></a><span class="co">#| eval: false</span></span>
<span id="cb24-265"><a href="#cb24-265"></a><span class="co">#| include: false</span></span>
<span id="cb24-266"><a href="#cb24-266"></a><span class="fu">write_rds</span>(syncom16s_seqs_mltree, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_seqs_mltree.rds"</span>))</span>
<span id="cb24-267"><a href="#cb24-267"></a><span class="in">```</span></span>
<span id="cb24-268"><a href="#cb24-268"></a></span>
<span id="cb24-271"><a href="#cb24-271"></a><span class="in">```{r}</span></span>
<span id="cb24-272"><a href="#cb24-272"></a><span class="co">#| eval: true</span></span>
<span id="cb24-273"><a href="#cb24-273"></a><span class="co">#| include: false</span></span>
<span id="cb24-274"><a href="#cb24-274"></a>syncom16s_seqs_mltree <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_seqs_mltree.rds"</span>))</span>
<span id="cb24-275"><a href="#cb24-275"></a><span class="in">```</span></span>
<span id="cb24-276"><a href="#cb24-276"></a></span>
<span id="cb24-279"><a href="#cb24-279"></a><span class="in">```{r}</span></span>
<span id="cb24-280"><a href="#cb24-280"></a><span class="co"># this function adds an 'edgetext' attribute that is recognized by WriteDendrogram so that</span></span>
<span id="cb24-281"><a href="#cb24-281"></a><span class="co"># branch support values (aBayes) are written properly</span></span>
<span id="cb24-282"><a href="#cb24-282"></a>add_boots <span class="ot">&lt;-</span> <span class="cf">function</span>(node){</span>
<span id="cb24-283"><a href="#cb24-283"></a>  s <span class="ot">&lt;-</span> <span class="fu">attr</span>(node, <span class="st">"probability"</span>)</span>
<span id="cb24-284"><a href="#cb24-284"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(s))</span>
<span id="cb24-285"><a href="#cb24-285"></a>    <span class="fu">attr</span>(node, <span class="st">"edgetext"</span>) <span class="ot">&lt;-</span> <span class="fu">formatC</span>(<span class="fu">as.numeric</span>(s), <span class="at">digits=</span><span class="dv">2</span>, <span class="at">format=</span><span class="st">"f"</span>)</span>
<span id="cb24-286"><a href="#cb24-286"></a>  <span class="fu">return</span>(node)</span>
<span id="cb24-287"><a href="#cb24-287"></a>}</span>
<span id="cb24-288"><a href="#cb24-288"></a></span>
<span id="cb24-289"><a href="#cb24-289"></a>syncom16s_seqs_mltree <span class="ot">&lt;-</span> <span class="fu">dendrapply</span>(syncom16s_seqs_mltree, add_boots)</span>
<span id="cb24-290"><a href="#cb24-290"></a><span class="in">```</span></span>
<span id="cb24-291"><a href="#cb24-291"></a></span>
<span id="cb24-292"><a href="#cb24-292"></a>Save ML tree as newick file</span>
<span id="cb24-293"><a href="#cb24-293"></a></span>
<span id="cb24-296"><a href="#cb24-296"></a><span class="in">```{r}</span></span>
<span id="cb24-297"><a href="#cb24-297"></a><span class="fu">WriteDendrogram</span>(syncom16s_seqs_mltree, </span>
<span id="cb24-298"><a href="#cb24-298"></a>                <span class="at">file=</span>here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"syncom16s_seqs_mltree.nwk"</span>),</span>
<span id="cb24-299"><a href="#cb24-299"></a>                <span class="co"># quote ="" ensure that bootstraps are not written quoted as strings</span></span>
<span id="cb24-300"><a href="#cb24-300"></a>                <span class="co"># so that ggtree doesn't fail to parse them</span></span>
<span id="cb24-301"><a href="#cb24-301"></a>                <span class="at">quote=</span><span class="st">""</span>)</span>
<span id="cb24-302"><a href="#cb24-302"></a><span class="in">```</span></span>
<span id="cb24-303"><a href="#cb24-303"></a></span>
<span id="cb24-304"><a href="#cb24-304"></a>Tree building results</span>
<span id="cb24-305"><a href="#cb24-305"></a></span>
<span id="cb24-306"><a href="#cb24-306"></a><span class="in">```         </span></span>
<span id="cb24-307"><a href="#cb24-307"></a><span class="in">Fitting initial tree to model:</span></span>
<span id="cb24-308"><a href="#cb24-308"></a><span class="in">GTR+G4 -ln(L) = 15520, AICc = 31633, BIC = 32781</span></span>
<span id="cb24-309"><a href="#cb24-309"></a></span>
<span id="cb24-310"><a href="#cb24-310"></a><span class="in">Optimizing up to 400 candidate trees:</span></span>
<span id="cb24-311"><a href="#cb24-311"></a><span class="in">Tree #136. -ln(L) = 15395.993 (0.000%), 9 Climbs, 0 Grafts of 7                                                                                                       </span></span>
<span id="cb24-312"><a href="#cb24-312"></a></span>
<span id="cb24-313"><a href="#cb24-313"></a><span class="in">Finalizing the best tree (#130):</span></span>
<span id="cb24-314"><a href="#cb24-314"></a><span class="in">-ln(L) = 15395.993 (0.000%), 1 Climb                                                                                                                                  </span></span>
<span id="cb24-315"><a href="#cb24-315"></a></span>
<span id="cb24-316"><a href="#cb24-316"></a><span class="in">Model parameters:</span></span>
<span id="cb24-317"><a href="#cb24-317"></a><span class="in">Frequency(A) = 0.244</span></span>
<span id="cb24-318"><a href="#cb24-318"></a><span class="in">Frequency(C) = 0.223</span></span>
<span id="cb24-319"><a href="#cb24-319"></a><span class="in">Frequency(G) = 0.312</span></span>
<span id="cb24-320"><a href="#cb24-320"></a><span class="in">Frequency(T) = 0.221</span></span>
<span id="cb24-321"><a href="#cb24-321"></a><span class="in">Rate A &lt;-&gt; C = 0.816</span></span>
<span id="cb24-322"><a href="#cb24-322"></a><span class="in">Rate A &lt;-&gt; G = 1.978</span></span>
<span id="cb24-323"><a href="#cb24-323"></a><span class="in">Rate A &lt;-&gt; T = 1.262</span></span>
<span id="cb24-324"><a href="#cb24-324"></a><span class="in">Rate C &lt;-&gt; G = 0.677</span></span>
<span id="cb24-325"><a href="#cb24-325"></a><span class="in">Rate C &lt;-&gt; T = 3.029</span></span>
<span id="cb24-326"><a href="#cb24-326"></a><span class="in">Rate G &lt;-&gt; T = 1.000</span></span>
<span id="cb24-327"><a href="#cb24-327"></a><span class="in">Alpha = 0.302</span></span>
<span id="cb24-328"><a href="#cb24-328"></a></span>
<span id="cb24-329"><a href="#cb24-329"></a><span class="in">Time difference of 1090.3 secs</span></span>
<span id="cb24-330"><a href="#cb24-330"></a><span class="in">```</span></span>
<span id="cb24-331"><a href="#cb24-331"></a></span>
<span id="cb24-332"><a href="#cb24-332"></a><span class="fu"># Aggregate various taxa information</span></span>
<span id="cb24-333"><a href="#cb24-333"></a></span>
<span id="cb24-336"><a href="#cb24-336"></a><span class="in">```{r}</span></span>
<span id="cb24-337"><a href="#cb24-337"></a><span class="co">#| echo: true</span></span>
<span id="cb24-338"><a href="#cb24-338"></a><span class="co">#| output: false</span></span>
<span id="cb24-339"><a href="#cb24-339"></a>sanger_batch_info <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sanger_seq"</span>, <span class="st">"sanger_batch_info_01.tsv"</span>))</span>
<span id="cb24-340"><a href="#cb24-340"></a><span class="in">```</span></span>
<span id="cb24-341"><a href="#cb24-341"></a></span>
<span id="cb24-344"><a href="#cb24-344"></a><span class="in">```{r}</span></span>
<span id="cb24-345"><a href="#cb24-345"></a>final_table <span class="ot">&lt;-</span> <span class="fu">left_join</span>(syncom16s_idtx_lineage_info, sanger_batch_info, <span class="at">by =</span> <span class="fu">join_by</span>(id <span class="sc">==</span> strainID)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-346"><a href="#cb24-346"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">strainID =</span> id, <span class="at">taxa_cluster =</span> cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb24-347"><a href="#cb24-347"></a>  <span class="fu">mutate</span>(<span class="at">genus1 =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(genus, <span class="st">"(^[:alpha:]*).*"</span>, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-348"><a href="#cb24-348"></a>  <span class="fu">mutate</span>(<span class="at">genus1 =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(genus1) <span class="sc">|</span> genus1 <span class="sc">==</span> <span class="st">"unclassified"</span> <span class="sc">~</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(ncbi_best_species, <span class="st">"^[:alpha:]*"</span>),</span>
<span id="cb24-349"><a href="#cb24-349"></a>                           <span class="cn">TRUE</span> <span class="sc">~</span> genus1)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-350"><a href="#cb24-350"></a>  <span class="fu">mutate</span>(<span class="at">tree_name =</span> <span class="fu">paste</span>(genus1, strainID)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-351"><a href="#cb24-351"></a>  <span class="fu">relocate</span>(<span class="fu">c</span>(bacteria_plate_well, location, google_drive_id, tree_name), <span class="at">.after =</span> strainID) <span class="sc">%&gt;%</span> </span>
<span id="cb24-352"><a href="#cb24-352"></a>  <span class="fu">relocate</span>(google_drive_id, taxa_cluster, tree_name, <span class="at">.after =</span> strainID) <span class="sc">%&gt;%</span> </span>
<span id="cb24-353"><a href="#cb24-353"></a>  <span class="fu">relocate</span>(ncbi_best_species, ncbi_taxid, <span class="at">.after =</span> location) <span class="sc">%&gt;%</span> </span>
<span id="cb24-354"><a href="#cb24-354"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>genus1)</span>
<span id="cb24-355"><a href="#cb24-355"></a></span>
<span id="cb24-356"><a href="#cb24-356"></a><span class="fu">write_tsv</span>(final_table, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"strain_table_info.tsv"</span>))</span>
<span id="cb24-357"><a href="#cb24-357"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>